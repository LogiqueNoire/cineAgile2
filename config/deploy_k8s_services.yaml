---
- name: Despliegue Consolidado de Microservicios
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    microservicios:
      - name: venta-api
        image: "{{ lookup('env', 'VENTA_IMAGE') }}"
        port: 8080
        replicas: 3

      - name: tiempo-api
        image: "{{ lookup('env', 'TIEMPO_IMAGE') }}"
        port: 8081
        replicas: 2

      - name: intranet-api
        image: "{{ lookup('env', 'INTRANET_IMAGE') }}"
        port: 8080
        replicas: 3

  tasks:
    - name: Aplicar Deployment y Service
      kubernetes.core.k8s:
        state: present
        definition: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: {{ item.name }}
            labels:
              app: {{ item.name }}
          spec:
            replicas: {{ item.replicas }}
            selector:
              matchLabels:
                app: {{ item.name }}
            template:
              metadata:
                labels:
                  app: {{ item.name }}
              spec:
                containers:
                - name: {{ item.name }}-container
                  image: {{ item.image }}
                  ports:
                  - containerPort: {{ item.port }}
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: {{ item.name }}
          spec:
            type: ClusterIP
            selector:
              app: {{ item.name }}
            ports:
            - port: 80
              targetPort: {{ item.port }}
      loop: "{{ microservicios }}"