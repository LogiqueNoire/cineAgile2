---
- name: Despliegue Consolidado de Microservicios (Venta, Tiempo, Intranet)
  #ansible-playbook deploy_all_microservices.yml
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Aplicar Deployment y Service para los 3 Microservicios
      kubernetes.core.k8s:
        state: present # Asegura que los recursos existan y se mantengan actualizados
        # El bloque 'definition' acepta todo el YAML consolidado
        definition: |
          # ====================================================================
          # 1. SERVICIO: VENTA-API
          # ====================================================================
          apiVersion: api/v1
          kind: Deployment
          metadata:
            name: venta-api
            labels:
              app: venta-api
          spec:
            # 3 Réplicas para HA en las 3 AZs
            replicas: 3 
            selector:
              matchLabels:
                app: venta-api
            template:
              metadata:
                labels:
                  app: venta-api
              spec:
                containers:
                - name: venta-container
                  797606048152.dkr.ecr.us-east-2.amazonaws.com/microservicio-intranet:30
                  ports:
                  - containerPort: 8080
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: venta-api
          spec:
            type: ClusterIP
            selector:
              app: venta-api
            ports:
            - port: 80
              targetPort: 8080 
          ---
          # ====================================================================
          # 2. SERVICIO: INTRANET
          # ====================================================================
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: intranet-api
            labels:
              app: intranet-api
          spec:
            replicas: 3 # 3 Réplicas para HA en las 3 AZs
            selector:
              matchLabels:
                app: intranet-api
            template:
              metadata:
                labels:
                  app: intranet-api
              spec:
                containers:
                - name: intranet-container
                  image: 797606048152.dkr.ecr.us-east-2.amazonaws.com/microservicio-intranet:30
                  ports:
                  - containerPort: 9000
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: intranet-api
          spec:
            type: ClusterIP
            selector:
              app: intranet-api
            ports:
            - port: 80
              targetPort: 9000
